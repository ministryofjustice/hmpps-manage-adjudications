{% from "govuk/components/table/macro.njk" import govukTable %}

{% macro rehabActivityConditionsCompletedTable(rehabActivities, readOnly) %}
  {% set rows = [] %}
  {% for data in rehabActivities %}

    {% set completeLink = '<p class="govuk-body govuk-!-margin-bottom-1"><a href="'+data.completeUrl+'" data-qa="completed-activity" class="govuk-link">Enter if the activity was completed satisfactorily <span class="govuk-visually-hidden"></span></a></p>' %}

    {% if data.rehabilitativeActivitiesCompleted === true %}
      {% if data.multipleActivitiesNotFirst %}
        {% set finalColumnContent = '' %}
      {% else %}
        {% set finalColumnContent = 'Yes' %}
      {% endif %}
    {% elif data.rehabilitativeActivitiesCompleted === false %}
      {% if data.multipleActivitiesNotFirst %}
        {% set finalColumnContent = '' %}
      {% else %}
        {% set finalColumnContent = data.rehabilitativeActivitiesNotCompletedOutcome | convertNotCompletedOutcome %}
      {% endif %}
    {% else %}
      {% if data.multipleActivitiesNotFirst or readOnly %}
        {% set finalColumnContent = '' %}
      {% else %}
        {% set finalColumnContent = completeLink %}
      {% endif %}
    {% endif %}

    {% set rows = (rows.push([
      {
        html: '' if data.multipleActivitiesNotFirst else 
          data.type | convertPunishmentType(data.stoppagePercentage, data.privilegeType, data.otherPrivilege),
          classes: "columnWidth20 noBottomBorder" if data.multipleActivitiesNotLast else 
            "columnWidth20"
      }, {
        text: data.details or 'Not entered',
        classes: "columnWidth20 noBottomBorder" if data.multipleActivitiesNotLast else 
          "columnWidth20"
      }, {
        text: data.endDate | endDateSessionNumberText(data.totalSessions)or 'Not entered',
        classes: "columnWidth20 noBottomBorder" if data.multipleActivitiesNotLast else 
          "columnWidth20"
      }, {
        text: data.monitor | initialiseName or 'Not entered',
        classes: "columnWidth17 noBottomBorder" if data.multipleActivitiesNotLast else 
          "columnWidth17"
      }, {
        html: finalColumnContent,
        classes: "columnWidth20 noBottomBorder" if data.multipleActivitiesNotLast
      }
    ]), rows) %}
  {% endfor %}
  {{ govukTable({
        head: [
          {
            html: "Suspended <br>punishment"
          },
          {
            html: "Activity <br>details"
          },
          {
            html: "End date and <br>number of sessions"
          },
          {
            text: "Who is monitoring the prisoner"
          },
          {
            text: "Completed satisfactorily"
          }
        ],
        rows: rows,
        attributes: {"data-qa": "rehabilitative-activities-table"}
      }) }}
{% endmacro %}